#!/bin/bash
set -euo pipefail

HATS_DIR="$(cd "$(dirname "$0")" && pwd)"

if [ -z "${1:-}" ]; then
    echo "Usage: ~/.hats/init <project-name>"
    echo ""
    echo "Creates a new Hats BDD project."
    exit 1
fi

PROJECT_NAME="$1"

if [ -d "$PROJECT_NAME" ]; then
    echo "Directory '$PROJECT_NAME' already exists."
    exit 1
fi

echo "Creating project: $PROJECT_NAME"

mkdir -p "$PROJECT_NAME"/{features,designs,shared,src,tests}

cat > "$PROJECT_NAME/CLAUDE.md" <<CLAUDEEOF
# Hats BDD Project

This project uses the [Hats](https://github.com/deadsimple-xyz/hats) BDD framework.

## Project structure:
- \`features/\` -- Gherkin specs (source of truth)
- \`designs/\` -- mockups and wireframes
- \`shared/\` -- cross-role knowledge (stack, setup, API docs)
- \`src/\` -- implementation code
- \`tests/\` -- automated tests
- \`status.json\` -- dev loop progress

## Role instructions:
Read your full instructions from \`$HATS_DIR/roles/manager.md\` before responding.

## Available commands:
- \`~/.hats/manager\` -- plan and spec with the Manager
- \`~/.hats/designer\` -- create mockups from specs
- \`~/.hats/cto\` -- decide technology stack
- \`~/.hats/qa\` -- generate tests from specs
- \`~/.hats/dev\` -- code until tests pass

Add \`--run\` to any command for autonomous execution.
CLAUDEEOF

cat > "$PROJECT_NAME/status.json" <<'EOF'
{}
EOF

cat > "$PROJECT_NAME/.gitignore" <<'EOF'
node_modules/
__pycache__/
venv/
.env
*.log
EOF

cd "$PROJECT_NAME"
git init -q
git add -A
git commit -q -m "init: scaffold Hats BDD project"

echo ""
echo "Project '$PROJECT_NAME' created."
echo ""
echo "Next steps:"
echo "  cd $PROJECT_NAME"
echo "  claude                  # talk to the Manager"
echo "  ~/.hats/designer        # Designer creates mockups"
echo "  ~/.hats/cto             # CTO decides tech stack"
echo "  ~/.hats/qa              # QA generates tests"
echo "  ~/.hats/dev             # Developer codes until green"
