#!/bin/bash
set -euo pipefail

HATS_DIR="$(cd "$(dirname "$0")" && pwd)"

if ! [ -f "tests/run-tests.sh" ]; then
    echo "No test runner found. Run ~/.hats/qa first."
    exit 1
fi

cat > status.json <<EOF
{
  "phase": "developing",
  "cycle": 1,
  "max_cycles": 5,
  "last_updated": "$(date -Iseconds)",
  "summary": "Developer working on implementation"
}
EOF

if [[ "${1:-}" == "--run" ]]; then
    claude --system-prompt "$(cat "$HATS_DIR/roles/dev.md")" \
      -p "Your goal: make ALL tests pass.

Steps:
1. Read features/*.feature to understand what to build
2. Read shared/stack.md for technology decisions (if it exists)
3. Read shared/setup.md for project setup info (if it exists)
4. Review designs/ for UI/UX requirements (if they exist)
5. Look at the existing tests to understand what is expected
6. Write the implementation
7. Run tests with: bash tests/run-tests.sh
8. If tests fail -- read errors, fix code, run tests again
9. Repeat until ALL tests pass or you are stuck

If you get stuck after several attempts, say so -- the human will help.
When all tests pass, update status.json phase to 'passed'."
else
    claude --system-prompt "$(cat "$HATS_DIR/roles/dev.md")"
fi
